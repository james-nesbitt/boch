#!/bin/sh
#
# Settings library
#


# Alias list add method
alias_add()
{
  list_add "alias_aliases" "${1}"
}
# Alias list retrieve method
aliases_get()
{
  list_get "alias_aliases"
}

###
# Mount related functions
#
#

# Add a mount to the system (of the form host:container)
settings_mount_addmount()
{
  list_add "machine_mountvolumes" $1
}

# get a list of added mounts
settings_mount_getmounts()
{
  local format="list"
  local mounts="`list_get "machine_mountvolumes"`"

  local flags=""
  while [ $# -gt 0 ]
  do
    case "$1" in
      -f|--format)
        format="$2"
        shift
        ;;
      -l|--list)
        format="list"
        ;;
      -m|--mount|--mounts)
        format="mount"
        ;;
      -s|--short)
        format="short"
        ;;
      *)
        break;
    esac
    shift
  done

  # $1 would allow for different formats
  case "${format}" in
    "mount")
      # allow hooks to alter the value
      mounts="`hooks_altervalue "mountvolumes" ${mounts}`"

      local mount=""
      for mount in ${mounts}; do
        echo " --volume=${mount}"
      done
      ;;
    "short")
      local mount=""
      for mount in ${mounts}; do
        echo "`path_shorten \"${mount%:*}\"`:${mount#*:}"
      done
      ;;
    *)
      echo "${mounts}"
      ;;
  esac
}

#
# This library doesn't do too much yet,
# other than run a lot of hooks
#

#############################
# include setting overrides #
#############################
#
# all of the usefull settings are made
# in settings hooks
#
settings_init()
{
  # First preprocess aliases
  if [ -n "${alias_aliases}" ]; then
    local alias=""
    local previous_aliases="${alias_aliases}"
    alias_aliases=""
    for alias in ${previous_aliases}; do
      if [ "${alias:0:1}" == "@" ]; then
        alias_add "${alias:1}"
      else
        alias_add "${alias}"
      fi
    done
  fi

  # Run settings initialization
  debug --level 7 --topic "SETTINGS" "Running settings hooks"

  # execute any existing settings hooks
  debug --level 8 --topic "SETTINGS" "Running settings pre hooks => hooks_execute settings --state pre"
  hooks_execute settings --state "pre" $@
  debug --level 8 --topic "SETTINGS" "Running settings hooks => hooks_execute settings"
  hooks_execute settings
  debug --level 8 --topic "SETTINGS" "Running settings post hooks => hooks_execute settings --state post"
  hooks_execute settings --state "post" $@
  debug --level 8 --topic "SETTINGS" "Finished running settings hooks"

  debug --level 7 --topic "SETTINGS" "Running settings hooks complete"
}
