#!/bin/sh
#
# Library handling
#

libraries_addpath()
{
  list_add "path_libraries" "${1}"
}
libraries_getpath()
{
  list_get "path_libraries"
}

# default library path
libraries_addpath "${path_manage}/libraries"

library_include()
{

  # empty defaults
  local library=""
  local component=""

  local path=""

  local path_library=""

  while [ $# -gt 0 ]
  do
    case "$1" in
      -c|--component)
        component=$2
        shift
        ;;
      *)
          break;; # terminate while loop
    esac
    shift
  done

  # library is the first thing loaded
  local library=$1
  shift

  local success=-1

  debug --level 9 --topic "LIBRARY->INCLUDE->" "Trying to includel library [library:${library}][component:${component}][library paths:`libraries_getpath`][included libraries:${included_libraries}]"

  # LIBRARY
  case " $included_libraries " in
    *" ${library} "*)
      debug --level 7 --topic "LIBRARY->INCLUDE" "library already included! [library:${library}][included_libraries:${included_libraries}]"
      success=0
    ;;

    *)
      # start off no success
      success=-1

      # mark success to show that we didn't find the library
      success=-1
      for path_library in `libraries_getpath`; do
        path="${path_library}/${library}"

        # check the path before trying to load it
        if [ -e ${path} ]; then
          debug --level 8 --topic "LIBRARY->INCLUDE" "trying to load library, handing off to library_load [library:${library}] =>  library_load --library \"${library}\" --path \"${path}\" $@"
          library_load --library "${library}" --path "${path_library}/${library}" $@

          if [ $? -gt -1 ]; then
            success=$?
            break;
          fi
        fi

      done
    ;;
  esac

  # COMPONENT
  if [ "${component}" != "" ] && [ $success -eq 0 ]; then

    # check if already attempted to oad this library component (if not mark it as attempted)
    case " $included_libraries " in
      *" ${library}:${component} "*)
          # already included

          debug --level 8 --topic "LIBRARY->INCLUDE->COMPONENT" "component already included [library:${library}][component:${component}][[included_library_components:${included_library_components}]"
          success=0
        ;;

      *)

        # mark success to show that we didn't find the library
        success=-1

        # if a component is of the form {parent}:{name} then split them, otherwise assume name={library}
        # path will be {library}/{parent}/{name}
        local component_parent="${component%:*}"
        if [ -z ${component_parent} ]; then
          component_parent=${component_parent:-${library}}
        fi
        local component_name="${component##*:}"

        for path_library in `libraries_getpath`; do
          # get the library path
          path="${path_library}/${library}/${component_parent}"

          # do a quick check on the path to save time
          if [ -d ${path} ]; then
            # full path to component
            path="${path}/${component_name}"

            # try to load the component as a library
            debug --level 8 --topic "LIBRARY->INCLUDE->COMPONENT" "trying to load library component, handing off to library_load [library:${library}][component:${component}] =>  library_load --library \"${library}:${component}\" --path \"${path}\" $@"
            library_load --library "${library}_${component}" --path "${path}" $@
            success=$?

            # if we found it then break (make a library_load return -1 to keep looking
            if [ $success -gt 1 ]; then
              break
            fi

          fi

        done

        if [ $success -eq -1 ]; then
          # library was not found
          debug --level 6 --topic "LIBRARY->INCLUDE->COMPONENT" "library component not found [library:${library}][component:${component}]"
          success=1
        fi

      ;;
    esac

  fi

  return $success
}

###
# load a library (or a component)
#

# Remember included libraries so we can prevent repeats
included_libraries=""
library_load()
{

  local library=""
  local path=""
  local corefile=""

  while [ $# -gt 0 ]
  do
    case "$1" in
      -c|--core)
        corefile=$2
        shift
        ;;
      -l|--library)
        library=$2
        shift
        ;;
      -p|--path)
        path=$2
        shift
        ;;
      *)
          break;; # terminate while loop
    esac
    shift
  done

  if [ -z ${library} ] || [ -z ${path} ]; then
    debug --level 6 --topic "LIBRARY->LOAD" "no library specified [library:${library}][path:${path}]!"
    return 1
  fi
  if [ -z "${corefile}" ]; then
    corefile="${library##*:}"
  fi

  # check if already attempted to load this library (if not mark it as attempted)
  case " $included_libraries " in
    *" ${library} "*)
        debug --level 7 --topic "LIBRARY->LOAD" "library already include [library:${library}][included_libraries:${included_libraries}]"
        return 0
      ;;

    *)
      # add library
      included_libraries="${included_libraries} ${library}"

      # init var
      local root_path=""

      debug --level 8 --topic "LIBRARY->LOAD" "trying to include library [library:${library}][path:${path}]"

      if [ ! -e ${path} ]; then
        debug --level 8 --topic "LIBRARY->LOAD" "library root does not exist [library:${library}][path:${path}]"
        return 1
      fi

      # if the path is a directory then assume that the whole directory is the library root
      if [ -d ${path} ]; then
        root_path="${path}/${corefile}"
        debug --level 8 --topic "LIBRARY->LOAD" "using path as library directory.[path:${root_path}]"
      else
        root_path="${path}"
        debug --level 8 --topic "LIBRARY->LOAD" "loading simple library (this library can't have components.) [path:${root_path}]"
      fi

      if [ -f ${root_path} ] && [ -x ${root_path} ]; then

        _libraries_hooks_exists
        if [ $? -eq 0 ]; then
          hooks_execute "library/load" --state "pre" --library ${library} --path ${path} $@
        fi

        debug --level 8 --topic "LIBRARY->LOAD" "Including library root.  Handing off to _include_source ==> _include_source \"${root_path}\" $@ "
        _include_source "${root_path}" $@

        if [ $? -eq 0 ]; then
          _libraries_hooks_exists
          if [ $? -eq 0 ]; then
            hooks_execute "library/load" --state "post" --library ${library} --path ${path} $@
          fi

          local path_librarylibraries="${path}/libraries"
          if [ -d "${path_librarylibraries}" ]; then
            libraries_addpath ${path_librarylibraries}
          fi

          debug --level 6 --topic "LIBRARY->LOAD" "library loaded [library:${library}][path:${path}]"
          return 0
        else
          debug --level 6 --topic "LIBRARY->LOAD" "library load failed  [library:{$library}][path:${path}]"

          _libraries_hooks_exists
          if [ $? -eq 0 ]; then
            hooks_execute "library/load" --state "fail" --library ${library} --path ${path} $@
          fi
          return 1
        fi

      else
        debug --level 8 --topic "LIBRARY->LOAD" "library root handler does not exist or is not executable for \"${root_path}\""
        return 1
      fi
    ;;
  esac
}

# has hooks been loaded yet?
_libraries_hooks_exist=1
_libraries_hooks_exists()
{
  if [ $_libraries_hooks_exist -eq 1 ]; then
    declare -f -F hooks_execute > /dev/null
    _libraries_hooks_exist=$?
  fi
  return $_libraries_hooks_exist
}

library_execute()
{

  # empty defaults
  local library=""
  local component=""
  local action="execute"

  while [ $# -gt 0 ]
  do
    case "$1" in
      -a|--action)
        action=$2
        shift
        ;;
      -c|--component)
        component=$2
        shift
        ;;
      *)
          break;; # terminate while loop
    esac
    shift
  done

  # library is the first thing loaded
  local library=$1
  shift

  local success=-1

  # include the library
  if [ "${component}" == "" ]; then
    library_include "${library}" $@
    success=$?

    # generate the library method
    library_function="${library##*:}_${action}"
  else
    library_include --component "${component}" "${library}" $@
    success=$?

    # generate the library method
    library_function="${component##*:}_${action}"
  fi

  if [ $success -eq 0 ]; then

    debug --level 7 --topic "LIBRARY->EXECUTE" "library [library:${library}][component:${component}] handing off to library script : ${library_function} $@"
    eval ${library_function} $@
    success=$?
    if [ $success == 0 ]; then
      echo "$result"
      debug --level 8 --topic "LIBRARY->EXECUTE" "Library execute succeeded [library:${library}][component:${component}][action:${action}]."

    else
      debug --level 6 --topic "LIBRARY->EXECUTE" "Command execution failed for library [library:${library}][component:${component}][action:${action}].  Command method returned an error"
    fi
    return $sucess

  else
    debug --level 6 --topic "LIBRARY->EXECUTE" "Command execution failed for library [library:${library}][component:${component}][action:${action}].  Could not find library or component"
    return 1
  fi
}

